# 개요

`탐색하기` 페이지를 렌더링하기 위해 개별 컴포넌트들을 조합하는 페이지.

# Design Pattern
- **Container Component**: 데이터를 하위 컴포넌트(Recommended, BottomSheet)에 전달하는 역할.
- **Composition Pattern**: Recommended, Sponsor, BottomSheet 등을 조합하여 페이지 구성.
- **Event Aggregator**: Toolbar 입력, 댓글 작성 등의 이벤트를 수집하고 처리.

# Pseudo code

## import
import recommend-n-search/Recommended.vue
import recommend-n-search/Sponsor.vue
import recommend-n-search/Search.ts
import bottom-sheet/BottomSheet.vue
import color_template.css
import i18n

## input

Props {
    pages: list[dict{
        title: string,
        description: string,
        favicon: string,
        url: string,
        keyword: list[string],
    }],
    comments: list[dict{
        nametag: string,
        content: string,
        commentId: string,
    }],
    toolbarOutput: {
        toolbar_operation: "search" | "talk",
        toolbar_input: string,
        suggestions_used: list[string]
    } | null,
    commentAuthor: {
        nickname: string,
        epithet: string
    },
    onSaveTabs: (tabs: list[dict]) => Promise<void>,
    onNavigatePending: () => void,
    onSubmitComment: (content: string) => Promise<void>,
    onCommentExpand: (commentId: string | null) => void
}

## State
State {
    filteredPages: list[dict],
    saveTabsStatus: "idle" | "loading" | "success" | "error"
}

## Output
Output {
    recommendedLayout: VerticalGrid,
    saveTabsRequest: {
        status: "idle" | "loading" | "success" | "error",
        payload: list[dict] | null
    }
}

## component

// 탭 저장 핸들러
async function handle_save_tabs() {
    try {
        State.saveTabsStatus = "loading"
        await Props.onSaveTabs({
            save_date: datetime.now(),
            pages: Props.pages
        })
        State.saveTabsStatus = "success"
        // 저장 성공 알림 표시
        Props.onNavigatePending()
    } catch (error) {
        State.saveTabsStatus = "error"
        console.error("Failed to save tabs:", error)
    }
}

SaveTabsButton = BoxButton(
    contains: Text(i18n.save_tabs),
    onPress: () => handle_save_tabs(),
    appearance: {
        borderRadius: 4,
        bgColor: color_template.main,
        hoverBgColor: color_template.grey-lv3,
        textColor: color_template.grey-lv1,
    },
)

suggestions = json.load("query_suggestions.json")
suggestions_appearance = {
    borderRadius: 4,
    hoverBgColor: color_template.grey-lv1,
    textColor: color_template.font-black,
}

// Toolbar 출력에 따른 검색 처리
last_operation = Props.toolbarOutput?.toolbar_operation || null
if last_operation == "search":
    // 검색어가 있으면 필터링, 없으면 전체 표시 (빈 입력으로 추천 쿼리만 표시)
    if Props.toolbarOutput.toolbar_input:
        State.filteredPages = Search.keyword_search(
            query: Props.toolbarOutput.toolbar_input,
            contents: Props.pages
        )
    else:
        State.filteredPages = Props.pages
    
    // 검색 모드에서는 항상 추천 쿼리 표시
    SuggestionsButton = [BoxButton(
        contains: Text(s), 
        onPress: {텍스트를 ToolBar에 입력, toolbar operation 수행}, 
        appearance: suggestions_appearance
    ) for s in suggestions.search]
elif last_operation == "talk":
    // AI 대화 모드 - 향후 구현
    State.filteredPages = Props.pages
    
    // 대화 모드에서는 항상 추천 쿼리 표시
    SuggestionsButton = [BoxButton(
        contains: Text(s), 
        onPress: {텍스트를 ToolBar에 입력, toolbar operation 수행}, 
        appearance: suggestions_appearance
    ) for s in suggestions.talk]
else:
    State.filteredPages = Props.pages
    SuggestionsButton = [SaveTabsButton]

// 추천 페이지 렌더링
listed_pages = [Recommended(
    page: page,
    onPageClick: (url) => OpenNewTab(url)
) for page in State.filteredPages]
listed_pages.random_insert(Sponsor())

RecommendedGrid = VerticalGrid(elements: [
    **SuggestionsButton,
    **listed_pages
    ]
)

BottomSheetComponent = BottomSheet(
    doc_comment: Props.comments,
    user_nickname: Props.commentAuthor.nickname,
    epithet: Props.commentAuthor.epithet,
    onSubmitComment: Props.onSubmitComment,
    onExpandChange: Props.onCommentExpand
)

DynamicDisplayRatio(
    direction: "vertical",
    elements: [RecommendedGrid, BottomSheetComponent],
    ratios: [recommended_ratio, bottom_sheet_ratio]{
        // 비율 관리 함수
        num_of_comments = len(Props.comments)
        num_of_recommended_pages = len(State.filteredPages)
        bottom_sheet_ratio = percent(18*num_of_comments - 4*num_of_recommended_pages - 5)     // 동적 사이즈 계산식
        if bottom_sheet_ratio < 40%:
            bottom_sheet_ratio = 40%  // 최소 40%로 변경
        if bottom_sheet_ratio > 60%:
            bottom_sheet_ratio = 60%
        recommended_ratio = 1 - bottom_sheet_ratio
    }
)