# 개요
Document(웹페이지)의 댓글을 표시하는 BottomSheet 컴포넌트.
Convex 백엔드와 연동하여 실시간으로 댓글을 가져오고 무한 스크롤을 지원합니다.

# Design Pattern
- **Presenter Pattern**: 댓글 데이터 목록을 Convex에서 가져와 렌더링하고, 사용자 인터랙션(작성, 확장)을 처리.
- **Event Handling**: 자식(CommentBox)의 이벤트를 받아 상태를 업데이트.
- **Accordion Pattern**: 댓글을 하나씩 확장/축소.
- **Infinite Scroll Pattern**: 스크롤 시 자동으로 더 많은 댓글 로드.

# Input / Output

## Input
Props {
    pageId: Id<'pages'>,  // Convex 페이지 ID
    user_nickname: string,
    epithet: string
}

## Output
Output {
    // Convex mutation을 통해 댓글 생성
    // 댓글 목록은 Convex query를 통해 자동으로 업데이트됨
}

# Pseudo code
import phosphor-icons
import CommentBox.vue   // 모듈 따로 작성
import color_template.css
import { useConvexQuery, useConvexMutation } from 'convex-vue'
import { api } from 'convex/_generated/api'

// 로컬 상태 관리 (BottomSheet 컴포넌트 내부)
State {
    expandedCommentId: string | null = null
    isWriting: boolean = False
    numItems: number = 20  // 무한 스크롤용 아이템 수
}

// Convex 쿼리 - 댓글 목록 가져오기 (무한 스크롤 지원)
ConvexQuery {
    query: api.comments.getCommentsByPage
    args: {
        pageId: Props.pageId,
        paginationOpts: { numItems: State.numItems, cursor: null }
    }
    returns: {
        page: Comment[],  // 댓글 목록 (최신순)
        continueCursor: string | null,  // 다음 페이지 커서
        isDone: boolean  // 더 이상 데이터 없음
    }
}

// Convex Mutation - 댓글 생성
ConvexMutation {
    mutation: api.comments.createComment
    args: {
        pageId: Id<'pages'>,
        content: string
    }
}

Methods {
    handleCommentExpand(commentId: string) {
        if (State.expandedCommentId === commentId) {
            State.expandedCommentId = null  // 같은 것 클릭 시 축소
        } else {
            State.expandedCommentId = commentId  // 다른 것 클릭 시 확장
        }
    }
    
    handleOutsideClick() {
        State.expandedCommentId = null  // 바깥 클릭 시 모든 확장 해제
    }
    
    async handleCommentSubmit() {
        if (commentInput.trim() && !isSubmitting) {
            try {
                await createComment({
                    pageId: Props.pageId,
                    content: commentInput
                })
                commentInput = ''
                State.isWriting = False
            } catch (error) {
                console.error("Failed to submit comment:", error)
            }
        }
    }
    
    handleScroll() {
        // 스크롤이 80%에 도달하면 더 많은 댓글 로드
        if (scrollPercentage > 0.8 && hasMore && !isLoading) {
            State.numItems += 20
        }
    }
}

nametag = String(user_nickname, fontColor: color_template.font-black) + String(" • ", fontColor: color_template.grey-lv3) + String(epithet, fontColor: color_template.grey-lv3)
separator = HorizontalGrid(
    Padding(hWidth: 20px),
    HorizontalLine(color: color_template.grey-lv3, width: 4px),
    Padding(hWidth: 20px),
)

comment_box = ScrollableVerticalGrid(
    elements: [
        LoadingSpinner() if isLoadingComments,
        CommentBox(
            nametag: c.userName,  // Convex에서 가져온 사용자 이름
            content: c.content,
            commentId: c._id,
            isExpanded: State.expandedCommentId === c._id,
            onExpand: (id) => handleCommentExpand(id)
        ) for c in comments,  // Convex query 결과
        LoadMoreIndicator() if hasMore && !isLoadingComments,
        EndIndicator("더 이상 댓글이 없습니다.") if !hasMore && comments.length > 0,
        EmptyIndicator("첫 댓글을 작성해보세요!") if comments.length === 0 && !isLoadingComments
    ],
    hPadding: 20px,
    maxHeight: 75vh,
    onScroll: handleScroll  // 무한 스크롤 핸들러
)

comment_write_box = VerticalGrid(
    elements: [
        ScrollableTextInputBox(
            placeholder: "코멘트를 입력하세요."
        ),
        HorizontalGrid(
            elements: [
                Padding(hWidth: max),
                IconButton(
                    phosphor-icons["Bold"].paper-plane-tilt,
                    onPress: () => handleCommentSubmit(comment_write_box.value)
                )
            ]
        )
    ]
)

VerticalGrid(
    elements: [
        Box(
            fill: gradient(
                start: color_template.background,     //below-side
                end: color_template.grey-lv2,       //upper-side
                rotate: 90deg
            ),
            hWidth: max,
            vLength: 18,
            onPress: () => handleOutsideClick()  // 상단 그라데이션 영역 클릭
        ),
        HorizontalGrid(
            elements:[
                nametag,
                Icon(
                    phosphor-icons["Bold"].pencil-simple-line,
                    color: color_template.grey-lv,
                    onPress: () => isWriting = True
                    )
            ],
            onPress: () => handleOutsideClick()  // 헤더 영역 클릭
        ),
        separator,
        comment_write_box if isWriting else comment_box
    ],
    shadow: Property(   // 위쪽 그림자 방향
        color: color_template.background,
        x-offset: 0px,
        y-offset: -10px
    ),
    onPress: () => handleOutsideClick()  // 전체 컨테이너 클릭 (이벤트 버블링 방지 필요)
)